# v1.0.4: Stock Analysis Automation Engine - Implementation Guide

**Version:** v1.0.4
**Date:** November 8, 2025
**Status:** In Progress

---

## Overview

This guide documents the implementation of automated daily stock analysis scheduling for Sage Stocks. The automation engine runs at 6am PT daily (Monday-Friday, market days only) and automatically analyzes stocks that users have opted into daily cadence.

**Key Features:**
- Fixed daily schedule (6am PT / 2pm UTC)
- Multi-user support (all users analyzed in single run)
- Per-stock opt-in (Analysis Cadence = "Daily")
- Tier-based limits (Free = 10 stocks, Starter = 50, Analyst = 200, Pro = unlimited)
- NYSE holiday validation
- Automatic Stock History record creation

---

## Phase 1: Notion Database Schema Changes

⚠️ **MANUAL STEP REQUIRED** - These properties must be added manually in Notion's database interface.

### A. Beta Users Database

Add the following properties to the **Beta Users** database:

1. **Subscription Tier**
   - Type: Select
   - Options: Free, Starter, Analyst, Pro
   - Default: Free
   - Description: "User's subscription level - determines analysis quotas and feature access"

2. **Timezone** *(Already exists from v1.0.3)*
   - Type: Text
   - Description: "User's IANA timezone (e.g., America/Los_Angeles)"
   - Note: Auto-detected from browser, stored but not used in v1.0.4

### B. Stock Analyses Database

Add the following properties to the **Stock Analyses** database:

1. **Analysis Cadence**
   - Type: Select
   - Options: None, Daily
   - Default: None
   - Description: "How often to automatically analyze this stock (opt-in per stock)"

2. **Last Auto-Analysis**
   - Type: Date (with time)
   - Description: "Timestamp of last automated analysis execution"
   - Note: Auto-populated by scheduled job

3. **Next Scheduled**
   - Type: Formula
   - Formula:
     ```
     if(prop("Analysis Cadence") == "Daily",
       dateAdd(prop("Last Auto-Analysis"), 1, "days"),
       "")
     ```
   - Description: "Next scheduled analysis date/time (for display only)"

---

## Phase 2: Code Implementation

### Files to Modify

1. **lib/auth.ts**
   - Add `subscriptionTier` and `timezone` to `User` interface
   - Update `mapNotionPageToUser()` to extract new properties

2. **config/notion-schema.ts**
   - Add automation properties to `STOCK_ANALYSES_SCHEMA`
   - Document Beta Users schema changes

3. **lib/notion-client.ts** *(No changes needed)*
   - Stock History writes already happen automatically in `/api/analyze`

### Files to Create

1. **api/cron/scheduled-analyses.ts**
   - Main cron endpoint
   - Market day validation
   - User loop with tier-based limits
   - Error handling and logging

2. **lib/market-calendar.ts** *(Optional - can inline in cron endpoint)*
   - NYSE holiday check using FMP API
   - Weekend validation
   - Hardcoded fallback for major holidays

### Files to Update

1. **vercel.json**
   - Add cron configuration: `0 14 * * *` (6am PT daily)

2. **.env.example**
   - Add `CRON_SECRET` environment variable
   - Add `NOTION_BETA_USERS_DB_ID` (if not already there)

---

## Phase 3: Implementation Details

### User Interface Updates

```typescript
// lib/auth.ts
export interface User {
  id: string;
  notionUserId: string;
  email: string;
  name: string;
  workspaceId: string;
  accessToken: string; // Encrypted
  status: 'pending' | 'approved' | 'denied';
  signupDate: string;
  dailyAnalyses: number;
  totalAnalyses: number;
  bypassActive: boolean;
  notes?: string;
  // NEW in v1.0.4
  subscriptionTier?: 'Free' | 'Starter' | 'Analyst' | 'Pro';
  timezone?: string; // IANA timezone
}

function mapNotionPageToUser(page: any): User {
  const props = page.properties;

  return {
    // ... existing mappings ...
    subscriptionTier: (props['Subscription Tier']?.select?.name || 'Free') as User['subscriptionTier'],
    timezone: props.Timezone?.rich_text?.[0]?.text?.content || undefined,
  };
}
```

### Tier Limits Configuration

```typescript
// In /api/cron/scheduled-analyses.ts
const TIER_LIMITS = {
  Free: 10,
  Starter: 50,
  Analyst: 200,
  Pro: Infinity,
};
```

### Market Day Validation

```typescript
// Simple implementation (can be in cron endpoint directly)
async function isNYSEMarketDay(): Promise<boolean> {
  const today = new Date();

  // Check weekend
  const dayOfWeek = today.getDay();
  if (dayOfWeek === 0 || dayOfWeek === 6) return false;

  // Check holidays (hardcoded fallback)
  const dateStr = today.toISOString().split('T')[0];
  const holidays2025 = [
    "2025-01-01", // New Year's Day
    "2025-01-20", // MLK Day
    "2025-02-17", // Presidents Day
    "2025-04-18", // Good Friday
    "2025-05-26", // Memorial Day
    "2025-07-04", // Independence Day
    "2025-09-01", // Labor Day
    "2025-11-27", // Thanksgiving
    "2025-12-25"  // Christmas
  ];

  if (holidays2025.includes(dateStr)) return false;

  // TODO: Future enhancement - query FMP holidays API

  return true;
}
```

### Cron Endpoint Structure

```typescript
// api/cron/scheduled-analyses.ts
import { VercelRequest, VercelResponse } from '@vercel/node';
import { getAllUsers } from '../../lib/auth';
import { Client } from '@notionhq/client';

const CRON_SECRET = process.env.CRON_SECRET || '';
const STOCK_ANALYSES_DB_ID = process.env.STOCK_ANALYSES_DB_ID || '';

export default async function handler(
  req: VercelRequest,
  res: VercelResponse
) {
  // 1. Verify cron secret
  const authHeader = req.headers.authorization;
  if (authHeader !== `Bearer ${CRON_SECRET}`) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  // 2. Check if today is a market day
  const isMarketDay = await isNYSEMarketDay();
  if (!isMarketDay) {
    console.log('[CRON] Market closed today, skipping scheduled analyses');
    return res.json({
      success: true,
      message: 'Market closed today',
      executed: 0
    });
  }

  console.log('[CRON] Starting scheduled analyses...');

  // 3. Get all beta users
  const users = await getAllUsers();
  console.log(`[CRON] Found ${users.length} users`);

  // 4. Execute analyses for each user
  const results = [];
  for (const user of users) {
    try {
      const userResult = await runScheduledAnalysesForUser(user);
      results.push(userResult);
    } catch (error) {
      console.error(`[CRON] Error for user ${user.email}:`, error);
      results.push({
        userId: user.id,
        email: user.email,
        analyzed: 0,
        skipped: 0,
        failed: 1,
        error: error instanceof Error ? error.message : String(error)
      });
    }
  }

  // 5. Return execution summary
  const summary = {
    success: true,
    totalUsers: users.length,
    executed: results.reduce((sum, r) => sum + r.analyzed, 0),
    skipped: results.reduce((sum, r) => sum + r.skipped, 0),
    failed: results.reduce((sum, r) => sum + r.failed, 0),
    results
  };

  console.log('[CRON] Scheduled analyses complete:', summary);
  return res.json(summary);
}

async function runScheduledAnalysesForUser(user: User) {
  const tier = user.subscriptionTier || 'Free';
  const stockLimit = TIER_LIMITS[tier];

  // Query stocks with Analysis Cadence = "Daily"
  const stocks = await getStocksForScheduledAnalysis(stockLimit);

  console.log(`[CRON] User ${user.email} (${tier}): ${stocks.length} stocks to analyze`);

  let analyzed = 0;
  let skipped = 0;
  let failed = 0;

  for (const stock of stocks) {
    try {
      // Call existing /api/analyze logic
      await analyzeStock(stock.ticker, stock.pageId, user);

      // Update Last Auto-Analysis timestamp
      await updateLastAutoAnalysis(stock.pageId);

      analyzed++;
    } catch (error) {
      console.error(`[CRON] Failed to analyze ${stock.ticker}:`, error);
      failed++;
    }
  }

  return {
    userId: user.id,
    email: user.email,
    tier,
    analyzed,
    skipped: Math.max(0, stocks.length - analyzed - failed),
    failed
  };
}
```

---

## Phase 4: Environment Variables

Add to Vercel environment variables:

```bash
# Cron authentication secret (generate with: openssl rand -hex 32)
CRON_SECRET=<random-64-char-hex-string>

# Beta Users database ID (if not already set)
NOTION_BETA_USERS_DB_ID=<database-id>
```

Add to `.env.example`:

```bash
# Cron Authentication
CRON_SECRET=your_cron_secret_here
```

---

## Phase 5: Vercel Cron Configuration

Update `vercel.json`:

```json
{
  "crons": [{
    "path": "/api/cron/scheduled-analyses",
    "schedule": "0 14 * * *"
  }]
}
```

**Schedule Explanation:**
- `0 14 * * *` = Every day at 14:00 UTC (6:00 AM PT / 9:00 AM ET)
- Runs 7 days/week, but endpoint checks for market days internally
- Alternative: `0 14 * * 1-5` to run Monday-Friday only (but still need holiday check)

---

## Phase 6: Testing Plan

### Local Testing

```bash
# 1. Set environment variables
export CRON_SECRET="test-secret-123"

# 2. Call endpoint locally
curl -X GET "http://localhost:3000/api/cron/scheduled-analyses" \
  -H "Authorization: Bearer test-secret-123"
```

### Staging Testing

1. Deploy to Vercel preview environment
2. Temporarily change cron schedule to hourly: `0 * * * *`
3. Monitor Vercel logs for execution
4. Verify analyses appear in Stock Analyses database
5. Check Stock History for historical records
6. Restore daily schedule before production deploy

### Production Validation

1. Deploy with daily schedule (`0 14 * * *`)
2. Monitor first 3 days of execution
3. Check Vercel logs for errors
4. Verify all users' stocks are analyzed correctly
5. Confirm tier limits are respected
6. Validate Stock History accumulation

---

## Success Criteria

✅ Cron runs daily at 6am PT (14:00 UTC)
✅ Skips weekends and NYSE holidays automatically
✅ All users with "Daily" cadence stocks get analyzed
✅ Tier limits enforced (Free = 10, Starter = 50, etc.)
✅ Each analysis creates Stock History record
✅ Execution completes in <5 minutes for 10 users × 10 stocks each
✅ Error logs show clear failure reasons for any failed analyses
✅ 95%+ success rate for scheduled analyses

---

## Future Enhancements (v1.0.8)

- User-configurable schedule times
- Multi-timezone support (hourly cron check)
- Weekly/Monthly cadence options
- Priority Level sorting
- Real-time FMP holidays API integration
- Email/Slack notifications for completed analyses
- Digest notifications (summary of changes)

---

## Rollback Plan

If critical issues arise:

1. **Disable cron:** Remove from `vercel.json` and redeploy
2. **Revert database changes:** Set all "Analysis Cadence" to "None"
3. **Monitor impact:** Check if manual analyses still work correctly
4. **Fix and redeploy:** Address issues in staging before re-enabling

---

## Change Log

**v1.0.4 (November 8, 2025)**
- Initial implementation of scheduled analysis automation
- Fixed 6am PT daily execution
- Multi-user support with tier-based limits
- NYSE holiday validation
- Stock History automatic accumulation
