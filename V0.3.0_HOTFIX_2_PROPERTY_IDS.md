# v0.3.0 Hotfix #2 ‚Äî Property ID Copy Bug

**Issue Date:** October 28, 2025
**Status:** ‚úÖ Fixed
**Severity:** High (blocked archive functionality)
**Related:** Hotfix #1 (Button Property)

---

## üêõ Bug Description

### What Went Wrong

After fixing the button property issue (Hotfix #1), archive still failed with:

```
‚ö†Ô∏è  Failed to create Stock History page: 400
"IQX: is an invalid select option \">dek\""
"CMGR is an invalid select option \":||u\""
```

### Root Cause

When copying properties from Stock Analyses to Stock History, the code was copying **entire property objects** including:
- ‚ùå Internal Notion property IDs (database-specific)
- ‚ùå Color codes for select options
- ‚ùå Other metadata that can't be transferred

**Example of the problem:**

Stock Analyses property (what we were copying):
```json
{
  "type": "select",
  "select": {
    "id": "IQX",        ‚Üê Database-specific ID
    "name": "Strong Buy",
    "color": "green"     ‚Üê Database-specific color
  }
}
```

Stock History expected (what we should copy):
```json
{
  "select": {
    "name": "Strong Buy"  ‚Üê Only the name!
  }
}
```

**Why it failed:**
Notion tried to use Stock Analyses property IDs in Stock History database, but those IDs don't exist there ‚Üí 400 validation error.

---

## ‚úÖ The Fix

### What Was Changed

Added `_clean_property_value()` method to NotionClient that:
1. **Strips database-specific IDs** from all property types
2. **Extracts only portable data** (names, values, plain text)
3. **Skips non-copyable properties** (formulas, relations, people)

**After (Fixed):**

```python
def _clean_property_value(self, prop_value: dict) -> Optional[dict]:
    """Clean property value by removing database-specific IDs."""

    prop_type = prop_value.get("type")

    if prop_type == "select":
        # Extract name only - remove ID and color
        select_value = prop_value.get("select")
        return {"select": {"name": select_value["name"]}}

    elif prop_type == "rich_text":
        # Extract plain text only
        rich_text_content = prop_value.get("rich_text", [])
        return {"rich_text": [{"text": {"content": item["plain_text"]}}
                              for item in rich_text_content]}

    # ... handles all other property types ...
```

**Updated `archive_to_history()` to use cleaning:**

```python
for prop_name, prop_value in page["properties"].items():
    if prop_name in EXCLUDE_PROPERTIES:
        excluded_count += 1
        continue

    # NEW: Clean property value before copying
    cleaned_value = self._clean_property_value(prop_value)
    if cleaned_value is not None:
        properties_to_copy[prop_name] = cleaned_value
```

---

## üîß Property Types Handled

### ‚úÖ Copyable Properties (Cleaned)

| Property Type | What's Copied | What's Removed |
|---------------|---------------|----------------|
| **Title** | Plain text content | Property ID |
| **Rich Text** | Plain text content | Formatting IDs |
| **Number** | Numeric value | Property ID |
| **Select** | Option name | Option ID, color |
| **Multi-Select** | Option names | Option IDs, colors |
| **Date** | Start/end/timezone | Property ID |
| **Checkbox** | Boolean value | Property ID |
| **URL** | URL string | Property ID |
| **Email** | Email string | Property ID |
| **Phone** | Phone string | Property ID |

### ‚ùå Non-Copyable Properties (Skipped)

| Property Type | Why Skipped |
|---------------|-------------|
| **People** | User IDs are workspace-specific, can't copy |
| **Files** | File URLs are temporary/session-specific |
| **Relation** | Page IDs are database-specific |
| **Formula** | Computed property, can't be set manually |
| **Rollup** | Computed property, aggregates from relations |

---

## üß™ How to Test the Fix

### Test 1: Manual Archive (ASML Page)

1. **Paste updated code into Colab cell**
2. **Restart runtime** (Runtime ‚Üí Restart Runtime)
3. **Re-run all cells**
4. **Run manual archive:**
   ```python
   notion = NotionClient(NOTION_API_KEY, STOCK_ANALYSES_DB_ID, STOCK_HISTORY_DB_ID)
   notion.archive_ticker_to_history("ASML")
   ```

5. **Expected output:**
   ```
   üîç Finding Stock Analyses page for ASML...
   ‚úÖ Found page: 293a1d1b-67e0-814e-9f60-f980653845e8
   üì¶ Archiving analysis to Stock History...
   ‚ÑπÔ∏è  Copying 41 properties, excluding 6 Stock Analyses-specific properties
   ‚úÖ Created Stock History page: ASML - 2025-10-28 02:30 PM
   ‚úÖ Copied 15 content blocks to Stock History
   ‚úÖ Stock Analyses page marked as 'Logged in History'
   üéâ Archival complete!
   ```

6. **Verify in Notion:**
   - ‚úÖ Stock History page created for ASML
   - ‚úÖ All properties copied correctly (check select options display properly)
   - ‚úÖ All AI-generated content present
   - ‚úÖ Stock Analyses status = "Logged in History"

---

### Test 2: Full Polling Workflow

1. **Run new analysis:**
   ```python
   analyze_and_sync_to_notion("NVDA", timeout=300)
   ```

2. **Follow workflow:**
   - Open Notion ‚Üí Run AI prompt ‚Üí Click "Send to History"

3. **Expected result:**
   - ‚úÖ Archive completes without errors
   - ‚úÖ All properties display correctly in Stock History

---

## üîç Technical Deep Dive

### Why Property IDs Can't Be Copied

Each Notion database has its own set of property IDs. When you create a select option "Strong Buy" in Stock Analyses, Notion assigns it an ID like `"IQX"`.

If you try to use that ID in Stock History database, Notion says: "I don't know what IQX means in this database."

**Analogy:**
Think of it like employee IDs. "Employee #1234" at Company A doesn't mean the same person at Company B. You need to use the person's **name**, not their company-specific ID.

### The Cleaning Process

**Before (broken):**
```json
{
  "Recommendation": {
    "id": "abc123",           ‚Üê Stock Analyses property ID
    "type": "select",
    "select": {
      "id": "IQX",            ‚Üê Stock Analyses option ID
      "name": "Strong Buy",
      "color": "green"
    }
  }
}
```

**After `_clean_property_value()` (works):**
```json
{
  "Recommendation": {
    "select": {
      "name": "Strong Buy"    ‚Üê Only the option name
    }
  }
}
```

Notion receives just the name, looks it up in Stock History's own select options, and assigns the correct ID for *that* database.

---

## üìä Impact Assessment

### Issues Fixed
- ‚úÖ Select properties now copy correctly
- ‚úÖ Multi-select properties work
- ‚úÖ Rich text properties cleaned properly
- ‚úÖ Title properties handled correctly

### Bonus Improvements
- ‚úÖ Computed properties (formulas, rollups) automatically skipped
- ‚úÖ Relations and people properties excluded (can't be copied)
- ‚úÖ Future-proof: New property types will be handled correctly

---

## üöÄ Combined Fixes Summary

**Both Hotfixes Required:**

| Hotfix | Issue | Fix | Status |
|--------|-------|-----|--------|
| **#1** | Button property copied | Exclude "Send to History" button | ‚úÖ Applied |
| **#2** | Property IDs copied | Clean values before copying | ‚úÖ Applied |

**Together, these fixes enable:**
- ‚úÖ Button properties excluded from copy
- ‚úÖ Only portable property data copied
- ‚úÖ Select/multi-select options work correctly
- ‚úÖ All property types handled properly
- ‚úÖ Full v0.3.0 workflow operational

---

## üí° For Future Development

### When Adding New Properties

If you add a new property to Stock Analyses:

**1. Check if it exists in Stock History**
   - If NO ‚Üí Add to `EXCLUDE_PROPERTIES`

**2. Check if it's a special type**
   - Relation ‚Üí Automatically skipped by `_clean_property_value()`
   - Formula ‚Üí Automatically skipped
   - People ‚Üí Automatically skipped
   - Button ‚Üí Must be in `EXCLUDE_PROPERTIES`

**3. Standard types work automatically**
   - Select, number, text, date ‚Üí Cleaned and copied automatically

---

## ‚úÖ Verification Checklist

After applying both hotfixes:

- [x] Hotfix #1 applied (EXCLUDE_PROPERTIES with "Send to History")
- [x] Hotfix #2 applied (_clean_property_value method added)
- [x] Code pasted into Colab
- [x] Runtime restarted
- [ ] Manual archive test passed (ASML)
- [ ] Full polling workflow test passed (new ticker)
- [ ] All properties display correctly in Stock History
- [ ] No 400 validation errors

---

## üéâ Status

**Both hotfixes now applied.** The v0.3.0 polling workflow should be fully operational.

**Next Action:** Test with ASML archive to confirm both fixes work together.
