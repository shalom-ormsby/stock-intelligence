<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Stock Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-inactive {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .indicator-active {
            background-color: #10b981;
        }
        .indicator-inactive {
            background-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Top Nav Bar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <span class="text-xl font-bold text-gray-900">âœ¨ Stock Intelligence</span>
                <a href="/analyze.html" class="text-sm text-gray-600 hover:text-gray-900 transition duration-200">
                    Analyzer
                </a>
                <span class="text-sm font-medium text-blue-600">Settings</span>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">
                    <span class="font-medium" id="user-email">Loading...</span>
                </span>
                <button
                    onclick="window.location.href='/api/auth/logout'"
                    class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded transition duration-200"
                >
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Settings</h1>
            <p class="text-gray-600">Manage your account and unlimited access</p>
        </div>

        <!-- Rate Limit Status Card -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Usage & Rate Limits</h2>

            <div class="space-y-4">
                <!-- Current Usage -->
                <div class="flex items-center justify-between py-3 border-b border-gray-200">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Analyses Today</p>
                        <p class="text-xs text-gray-500">Resets daily at midnight UTC</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-gray-900" id="usage-count">
                            <span class="text-gray-400">--</span>/<span class="text-gray-400">--</span>
                        </p>
                        <p class="text-xs text-gray-500" id="reset-time">Loading...</p>
                    </div>
                </div>

                <!-- Bypass Status -->
                <div class="flex items-center justify-between py-3">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Unlimited Access</p>
                        <p class="text-xs text-gray-500">Bypass rate limits until midnight UTC</p>
                    </div>
                    <div id="bypass-status-badge">
                        <span class="status-badge status-inactive">
                            <span class="status-indicator indicator-inactive"></span>
                            Inactive
                        </span>
                    </div>
                </div>

                <!-- Expiration (hidden by default) -->
                <div id="bypass-expiration" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-800">
                        <span class="font-medium">Active until:</span> <span id="expiration-time">--</span>
                    </p>
                    <p class="text-xs text-blue-600 mt-1">
                        Time remaining: <span id="time-remaining" class="font-medium">--</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Bypass Activation Card -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Activate Unlimited Access</h2>
            <p class="text-gray-600 mb-6">
                Enter your bypass code to enable unlimited stock analyses for the rest of the day.
                The bypass automatically expires at midnight UTC (4:00 PM Pacific Time).
            </p>

            <!-- Bypass Code Input -->
            <div class="mb-6">
                <label for="bypass-code" class="block text-sm font-medium text-gray-700 mb-2">
                    Bypass Code
                </label>
                <input
                    type="text"
                    id="bypass-code"
                    placeholder="Enter your bypass code"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <p class="text-xs text-gray-500 mt-2">
                    Don't have a code? Contact your administrator or check your Vercel environment variables.
                </p>
            </div>

            <!-- Activate Button -->
            <button
                id="activate-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
            >
                Activate Unlimited Access
            </button>

            <!-- Success Message -->
            <div id="success-message" class="hidden mt-6 bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-green-800 font-medium" id="success-text">Unlimited access activated!</p>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-red-800 font-medium" id="error-text">Activation failed</p>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-2">How It Works</h3>
            <ul class="text-sm text-blue-800 space-y-2">
                <li class="flex items-start">
                    <svg class="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span>Enter your bypass code and click "Activate Unlimited Access"</span>
                </li>
                <li class="flex items-start">
                    <svg class="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span>Once activated, you can run unlimited stock analyses for the rest of the day</span>
                </li>
                <li class="flex items-start">
                    <svg class="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span>Bypass automatically expires at midnight UTC and needs to be reactivated</span>
                </li>
                <li class="flex items-start">
                    <svg class="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span>To change the bypass code, update <code class="bg-blue-100 px-1 py-0.5 rounded text-xs">RATE_LIMIT_BYPASS_CODE</code> in Vercel dashboard</span>
                </li>
            </ul>
        </div>
    </div>

    <script>
        let userData = null;

        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/session');
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.href = '/';
                    return false;
                }

                userData = data.user;
                document.getElementById('user-email').textContent = data.user.email;
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
                return false;
            }
        }

        // Load usage and bypass status
        async function loadStatus() {
            try {
                // Load rate limit usage
                const usageResponse = await fetch('/api/usage');
                const usageData = await usageResponse.json();

                if (usageData.success) {
                    const used = usageData.usage.count;
                    const total = 10; // Default rate limit
                    const remaining = usageData.usage.remaining;

                    document.getElementById('usage-count').innerHTML =
                        `<span class="text-gray-900">${used}</span>/<span class="text-gray-600">${total}</span>`;

                    const resetAt = new Date(usageData.usage.resetAt);
                    const now = new Date();
                    const hoursUntilReset = Math.floor((resetAt - now) / (1000 * 60 * 60));
                    const minutesUntilReset = Math.floor(((resetAt - now) % (1000 * 60 * 60)) / (1000 * 60));

                    document.getElementById('reset-time').textContent =
                        `Resets in ${hoursUntilReset}h ${minutesUntilReset}m`;
                }

                // Check bypass status by attempting to get session info
                // We'll check if user has active bypass by looking at their usage
                if (usageData.success && usageData.usage.bypassed) {
                    updateBypassStatus(true, usageData.usage.resetAt);
                } else {
                    updateBypassStatus(false);
                }
            } catch (error) {
                console.error('Failed to load status:', error);
            }
        }

        // Update bypass status UI
        function updateBypassStatus(active, expiresAt = null) {
            const statusBadge = document.getElementById('bypass-status-badge');
            const expirationDiv = document.getElementById('bypass-expiration');

            if (active && expiresAt) {
                statusBadge.innerHTML = `
                    <span class="status-badge status-active">
                        <span class="status-indicator indicator-active"></span>
                        Active
                    </span>
                `;

                const expireDate = new Date(expiresAt);
                document.getElementById('expiration-time').textContent =
                    expireDate.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        timeZoneName: 'short'
                    });

                expirationDiv.classList.remove('hidden');
                updateTimeRemaining(expireDate);

                // Update time remaining every minute
                setInterval(() => updateTimeRemaining(expireDate), 60000);
            } else {
                statusBadge.innerHTML = `
                    <span class="status-badge status-inactive">
                        <span class="status-indicator indicator-inactive"></span>
                        Inactive
                    </span>
                `;
                expirationDiv.classList.add('hidden');
            }
        }

        // Update time remaining countdown
        function updateTimeRemaining(expireDate) {
            const now = new Date();
            const diff = expireDate - now;

            if (diff <= 0) {
                document.getElementById('time-remaining').textContent = 'Expired';
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            document.getElementById('time-remaining').textContent = `${hours}h ${minutes}m`;
        }

        // Activate bypass handler
        document.getElementById('activate-btn').addEventListener('click', async () => {
            const code = document.getElementById('bypass-code').value.trim();
            const btn = document.getElementById('activate-btn');
            const successMsg = document.getElementById('success-message');
            const errorMsg = document.getElementById('error-message');

            // Hide previous messages
            successMsg.classList.add('hidden');
            errorMsg.classList.add('hidden');

            if (!code) {
                showError('Please enter a bypass code');
                return;
            }

            if (!userData || !userData.id) {
                showError('User ID not found. Please refresh the page.');
                return;
            }

            // Disable button during request
            btn.disabled = true;
            btn.textContent = 'Activating...';
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const response = await fetch('/api/bypass', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userData.id,
                        code: code,
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message || 'Unlimited access activated until midnight UTC!');
                    updateBypassStatus(true, data.expiresAt);

                    // Clear the input
                    document.getElementById('bypass-code').value = '';

                    // Reload status
                    setTimeout(() => loadStatus(), 1000);
                } else {
                    showError(data.error || 'Failed to activate bypass. Please check your code.');
                }
            } catch (error) {
                console.error('Activation request failed:', error);
                showError('Request failed: ' + error.message);
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.textContent = 'Activate Unlimited Access';
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // Show success message
        function showSuccess(message) {
            const successMsg = document.getElementById('success-message');
            const errorMsg = document.getElementById('error-message');

            errorMsg.classList.add('hidden');
            document.getElementById('success-text').textContent = message;
            successMsg.classList.remove('hidden');
        }

        // Show error message
        function showError(message) {
            const successMsg = document.getElementById('success-message');
            const errorMsg = document.getElementById('error-message');

            successMsg.classList.add('hidden');
            document.getElementById('error-text').textContent = message;
            errorMsg.classList.remove('hidden');
        }

        // Allow Enter key to activate
        document.getElementById('bypass-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('activate-btn').click();
            }
        });

        // Initialize page
        (async () => {
            const authenticated = await checkAuth();
            if (authenticated) {
                await loadStatus();
                // Auto-refresh status every 30 seconds
                setInterval(loadStatus, 30000);
            }
        })();
    </script>
</body>
</html>
