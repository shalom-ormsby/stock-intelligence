/**
 * Setup Flow JavaScript - Single-Page Subway Map Setup
 * Handles all 6 steps of the onboarding flow with persistent progress indication
 */

// ============================================================================
// Constants & Configuration
// ============================================================================

const STEPS = [
  {
    number: 1,
    title: 'Connect Notion',
    icon: 'üîó',
    duration: '1 min',
    description: 'Sign in with Notion',
  },
  {
    number: 2,
    title: 'Setup Workspace',
    icon: 'üìÑ',
    duration: '3-5 min',
    description: 'Creating your databases',
  },
  {
    number: 3,
    title: 'Run First Analysis',
    icon: 'üìä',
    duration: '1 min',
    description: 'Analyze a stock',
  },
];

const TEMPLATE_URL = 'https://www.notion.so/Sage-Stocks-2a9a1d1b67e0818b8e9fe451466994fc';

// ============================================================================
// Global State
// ============================================================================

let currentState = {
  setupComplete: false,
  currentStep: 1,
  completedSteps: [],
  setupProgress: null,
  user: null,
  pollingInterval: null,
};

// ============================================================================
// Helper Functions
// ============================================================================

/**
 * Handle setup flow initiation with database check
 * v1.2.15: Skip OAuth entirely for existing users (prevents template duplication)
 */
async function handleSetupStart(emailInput = null) {
  // Check if user has an existing session
  const hasSessionCookie = document.cookie.includes('si_session=');
  const savedEmail = localStorage.getItem('sage_stocks_user_email');

  let userEmail = emailInput || savedEmail;

  if (!userEmail && !hasSessionCookie) {
    console.log('‚ú® No email provided - UI should show email input');
    return;
  }

  // Normalize and save email
  if (userEmail) {
    userEmail = userEmail.toLowerCase().trim();
    localStorage.setItem('sage_stocks_user_email', userEmail);
  }

  // Check database: Route based on user status
  try {
    console.log('üîç Checking database for existing user...');

    if (userEmail) {
      const response = await fetch(`/api/auth/check-email?email=${encodeURIComponent(userEmail)}`);
      const data = await response.json();

      if (!data.requiresOAuth && data.redirectTo) {
        // v1.2.15+: Handle redirects (Existing user -> App, New user -> Manual Setup)
        console.log(`‚úÖ Redirecting based on API response: ${data.redirectTo}`);
        window.location.href = data.redirectTo;
      } else if (data.requiresOAuth) {
        // New user OR reconnection needed: Go through OAuth
        console.log('üîê OAuth required - redirecting to authorization');
        proceedToOAuth(userEmail);
      }
    } else if (hasSessionCookie) {
      // Has session: Skip to app
      console.log('‚úÖ Session detected - going to app');
      window.location.href = '/analyze.html';
    }
  } catch (error) {
    console.error('‚ùå Database check failed:', error);
    // On error, go to OAuth and let backend handle it
    proceedToOAuth(userEmail);
  }
}

/**
 * Proceed to OAuth (after database check or manual setup)
 */
function proceedToOAuth(email = null) {
  let authUrl = '/api/auth/authorize';

  if (email) {
    authUrl += `?email=${encodeURIComponent(email)}`;
  }

  console.log('üöÄ Proceeding to OAuth:', authUrl);
  window.location.href = authUrl;
}

/**
 * Show manual template setup step (for new users)
 */
function showManualSetupStep() {
  console.log('üìÑ Showing manual template setup');
  // Navigate to Step 1.5 (manual setup)
  window.location.href = '/?step=1.5';
}

// ============================================================================
// Initialization
// ============================================================================

document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ Setup flow initialized');

  // Check for URL params (OAuth callback, errors, etc.)
  const params = new URLSearchParams(window.location.search);
  const stepParam = params.get('step');
  const errorParam = params.get('error');
  const statusParam = params.get('status');

  // Handle errors
  if (errorParam) {
    showError(getErrorMessage(errorParam));
  }

  // Load setup status from API first (to check if they've been approved since last visit)
  await loadSetupStatus();

  // If they have a session but status param says pending/denied, check actual status from API
  if (statusParam === 'pending' || statusParam === 'denied') {
    console.log('üîç Checking approval status from API...');
    console.log('   URL param:', statusParam);
    console.log('   API user status:', currentState.user?.status);
    console.log('   User object:', currentState.user);

    // User object from API will have current approval status
    if (currentState.user && currentState.user.status === 'approved') {
      // They were approved! Redirect to step 2 (duplicate template)
      console.log('‚úÖ User approved! Redirecting to step 2...');
      window.location.href = '/?step=2';
      return;
    } else {
      // Still pending/denied - show status message but ALSO show subway map
      console.log('‚è≥ User still pending/denied, showing status message');
      renderSubwayMap();
      showStatusMessage(statusParam);
      return;
    }
  }

  // v1.2.14: Step 1.5 = Manual template setup (BEFORE OAuth)
  if (stepParam === '1.5') {
    console.log('üìÑ Showing Step 1.5: Manual template setup');
    currentState.currentStep = 1.5;
    currentState.completedSteps = [];
    renderSubwayMap();
    renderStep1_5Content();
    return;
  }

  // If OAuth callback just completed (step=2 means OAuth succeeded, now verify)
  if (stepParam === '2') {
    currentState.currentStep = 2;
    currentState.completedSteps = [1]; // OAuth (step 1) is now complete
    await advanceToStep(2, { step1Complete: true });
  }

  // Render subway map and content
  renderSubwayMap();
  renderStepContent();

  // Auto-trigger database detection if we just completed Step 2 (duplicate)
  if (currentState.currentStep === 3) {
    setTimeout(() => {
      triggerAutoDetection();
    }, 500);
  }
});

// ============================================================================
// Database Auto-Detection (Critical for setup completion)
// ============================================================================

/**
 * Trigger automatic database detection
 * Called automatically after workspace verification (Step 2 ‚Üí Step 3 transition)
 *
 * This function is CRITICAL - without it, database IDs remain empty and
 * analysis attempts will fail with "database not configured" errors.
 */
async function triggerAutoDetection() {
  console.log('üîç Starting automatic database detection...');

  try {
    const response = await fetch('/api/setup/detect', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });

    const data = await response.json();

    console.log('üì° Detection API response:', response.status, data);

    if (!response.ok) {
      throw new Error(data.error || 'Detection failed');
    }

    if (data.success && data.detection) {
      const { stockAnalysesDb, stockHistoryDb, stockEventsDb, marketContextDb, sageStocksPage, needsManual } = data.detection;

      // Check if all required databases were found
      if (!needsManual && stockAnalysesDb && stockHistoryDb && stockEventsDb && marketContextDb && sageStocksPage) {
        console.log('‚úÖ Auto-detection successful!');
        console.log('   Stock Analyses DB:', stockAnalysesDb.id);
        console.log('   Stock History DB:', stockHistoryDb.id);
        console.log('   Stock Events DB:', stockEventsDb.id);
        console.log('   Market Context DB:', marketContextDb.id);
        console.log('   Sage Stocks Page:', sageStocksPage.id);

        // Database IDs are already saved by the backend (api/setup/detect.ts lines 71-102)
        // User can now proceed to Step 3 (first analysis)
      } else if (needsManual) {
        console.warn('‚ö†Ô∏è  Partial detection - some databases not found');
        console.log('   Found:', {
          stockAnalysesDb: !!stockAnalysesDb,
          stockHistoryDb: !!stockHistoryDb,
          stockEventsDb: !!stockEventsDb,
          marketContextDb: !!marketContextDb,
          sageStocksPage: !!sageStocksPage,
        });

        // Show error to user - manual entry would be needed
        showError('Could not find all databases in your workspace. Please verify you duplicated the Sage Stocks template correctly.');
      } else {
        console.error('‚ùå Detection succeeded but returned unexpected data structure');
        showError('Database detection completed with unexpected results. Please contact support.');
      }
    } else {
      console.error('‚ùå Detection API returned unexpected response:', data);
      showError('Database detection failed. Please contact support.');
    }
  } catch (error) {
    console.error('‚ùå Auto-detection failed:', error);
    showError(`Database detection failed: ${error.message}. Please refresh and try again, or contact support.`);
  }
}

// ============================================================================
// API Communication
// ============================================================================

async function loadSetupStatus() {
  try {
    console.log('üì° Loading setup status from API...');
    const response = await fetch('/api/setup/status');
    const data = await response.json();

    console.log('üì° API response:', response.status, data);

    if (!response.ok) {
      if (data.requiresAuth) {
        // No session - show Step 1 & 2 (pre-OAuth)
        console.log('üîí No session, starting from Step 1');
        currentState.currentStep = 1;
        currentState.completedSteps = [];
        return;
      }
      throw new Error(data.error || 'Failed to load setup status');
    }

    currentState.setupComplete = data.setupComplete;
    currentState.setupProgress = data.setupProgress;
    currentState.user = data.user;
    currentState.currentStep = data.setupProgress?.currentStep || 1;
    currentState.completedSteps = data.setupProgress?.completedSteps || [];

    console.log('‚úÖ Setup status loaded:', {
      setupComplete: currentState.setupComplete,
      currentStep: currentState.currentStep,
      userStatus: currentState.user?.status,
    });

    // If setup is complete, redirect to analyzer
    if (data.setupComplete && currentState.currentStep === 6) {
      console.log('‚úì Setup complete, redirecting to analyzer...');
      setTimeout(() => {
        window.location.href = '/analyze.html';
      }, 1000);
    }
  } catch (error) {
    console.error('‚ùå Failed to load setup status:', error);
    // Assume fresh user if API fails
    currentState.currentStep = 1;
    currentState.completedSteps = [];
  }
}

async function advanceToStep(step, data = null) {
  try {
    const response = await fetch('/api/setup/advance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ step, data }),
    });

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.error || 'Failed to advance step');
    }

    currentState.setupProgress = result.setupProgress;
    currentState.currentStep = result.setupProgress.currentStep;
    currentState.completedSteps = result.setupProgress.completedSteps;

    renderSubwayMap();
    renderStepContent();

    console.log(`‚úì Advanced to step ${step}`);
  } catch (error) {
    console.error(`‚ùå Failed to advance to step ${step}:`, error);
    showError(`Failed to update progress: ${error.message}`);
  }
}

// ============================================================================
// Subway Map Rendering
// ============================================================================

function renderSubwayMap() {
  const desktopContainer = document.querySelector('#subway-map .hidden.md\\:flex');
  const mobileContainer = document.querySelector('#subway-map .md\\:hidden');

  if (!desktopContainer || !mobileContainer) return;

  // Clear existing content
  desktopContainer.innerHTML = '';
  mobileContainer.innerHTML = '';

  // Render each step
  STEPS.forEach((step, index) => {
    const state = getStepState(step.number);
    const isLast = index === STEPS.length - 1;

    // Desktop (horizontal)
    desktopContainer.appendChild(createStepIndicator(step, state, false, isLast));

    // Mobile (vertical)
    mobileContainer.appendChild(createStepIndicator(step, state, true, isLast));
  });

  // Update progress badge
  updateProgressBadge();
}

function createStepIndicator(step, state, isVertical, isLast) {
  const container = document.createElement('div');
  container.className = isVertical ? 'relative' : 'flex-1 text-center relative';

  const indicator = document.createElement('div');
  indicator.className = `step-indicator ${state} ${state === 'in-progress' ? 'pulse-slow' : ''}`;

  if (state === 'complete') {
    indicator.innerHTML = '‚úì';
  } else if (state === 'in-progress') {
    indicator.innerHTML = `<div class="spinner" style="width: 20px; height: 20px; border: 3px solid #3B82F6; border-top-color: transparent; border-radius: 50%;"></div>`;
  } else {
    indicator.textContent = step.number;
  }

  const title = document.createElement('div');
  title.className = 'mt-2 font-semibold text-sm text-gray-900';
  title.textContent = step.title;

  const description = document.createElement('div');
  description.className = 'text-xs text-gray-600 mt-1';
  description.textContent = `${step.icon} ${step.description}`;

  const duration = document.createElement('div');
  duration.className = 'text-xs text-gray-500 mt-1';
  duration.textContent = step.duration ? `‚è±Ô∏è ${step.duration}` : '';

  if (isVertical) {
    const content = document.createElement('div');
    content.className = 'flex items-start gap-4';

    const indicatorWrapper = document.createElement('div');
    indicatorWrapper.className = 'relative flex-shrink-0';
    indicatorWrapper.appendChild(indicator);

    // Add connector line for vertical layout (except last step)
    if (!isLast) {
      const connector = document.createElement('div');
      connector.className = `subway-connector ${state === 'complete' ? 'complete' : ''}`;
      indicatorWrapper.appendChild(connector);
    }

    const textContent = document.createElement('div');
    textContent.className = 'flex-1 pt-2';
    textContent.appendChild(title);
    textContent.appendChild(description);
    if (step.duration) textContent.appendChild(duration);

    content.appendChild(indicatorWrapper);
    content.appendChild(textContent);
    container.appendChild(content);
  } else {
    container.appendChild(indicator);
    container.appendChild(title);
    container.appendChild(description);
    if (step.duration) container.appendChild(duration);
  }

  return container;
}

function getStepState(stepNumber) {
  if (currentState.completedSteps.includes(stepNumber)) {
    return 'complete';
  }
  if (currentState.currentStep === stepNumber) {
    return 'in-progress';
  }
  return 'pending';
}

function updateProgressBadge() {
  const badge = document.getElementById('progress-badge');
  const badgeStep = document.getElementById('badge-step');

  if (!badge || !badgeStep) return;

  if (currentState.currentStep <= 5) {
    badge.classList.remove('hidden');
    badgeStep.textContent = currentState.currentStep;
  } else {
    badge.classList.add('hidden');
  }
}

// ============================================================================
// Step Content Rendering
// ============================================================================

function renderStepContent() {
  const container = document.getElementById('setup-content');
  if (!container) return;

  container.innerHTML = '';

  // Render content based on current step
  switch (currentState.currentStep) {
    case 1:
      container.appendChild(createStep1Content());
      break;
    case 2:
      container.appendChild(createStep2Content());
      break;
    case 3:
      // Step 3: Run first analysis on the setup page
      container.appendChild(createStep3Content());
      break;
    case 4:
    case 5:
    case 6:
      // Legacy steps from old 6-step flow - should not be reached
      console.warn(`Legacy step ${currentState.currentStep} reached, showing step 3...`);
      container.appendChild(createStep3Content());
      break;
  }
}

// ============================================================================
// Step 1: Sign In with Notion (OAuth)
// ============================================================================

function createStep1Content() {
  const section = document.createElement('div');
  section.className = 'slide-in';

  // v1.2.9: Detect mobile/tablet devices
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  const mobileWarning = isMobile ? `
    <div class="mb-4 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
      <p class="text-yellow-800 font-medium mb-2">üì± Mobile Device Detected</p>
      <p class="text-sm text-yellow-700">
        <strong>Important:</strong> Setup works best on desktop. If you encounter issues, please visit this page on a desktop computer for the smoothest experience.
      </p>
    </div>
  ` : '';

  // Check if we have saved email in localStorage
  const savedEmail = localStorage.getItem('sage_stocks_user_email');
  const hasSession = document.cookie.includes('si_session=');

  // If we have session or saved email, skip email input
  const needsEmailInput = !hasSession && !savedEmail;

  section.innerHTML = `
    ${mobileWarning}
    <div class="mb-6 p-6 rounded-lg border bg-blue-50 border-blue-200">
      <div class="flex items-start">
        <div class="text-3xl mr-4">üîó</div>
        <div class="flex-1">
          <h3 class="font-bold text-gray-900 text-xl mb-2">Step 1 of 3: Connect Your Notion Account</h3>
          <p class="text-gray-700 mb-4">
            Connect your Notion account to get started with Sage Stocks.<br>
            <strong>Setup takes about 5 minutes.</strong>
          </p>

          ${needsEmailInput ? `
            <div class="mb-4 p-4 bg-white border border-blue-200 rounded-lg">
              <label class="block text-sm font-medium mb-2 text-gray-700">
                üìß Enter your email to get started
              </label>
              <p class="text-xs text-gray-600 mb-3">
                We'll use this to identify your account and send you updates. You only need to enter this once per browser.
              </p>
              <div class="flex gap-2">
                <input
                  type="email"
                  id="user-email-input"
                  placeholder="your@email.com"
                  class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                  required
                />
              </div>
              <p id="email-error" class="hidden text-sm text-red-600 mt-2"></p>
            </div>
          ` : savedEmail ? `
            <div class="mb-4 p-3 bg-white border border-blue-200 rounded-lg">
              <p class="text-sm text-gray-700">
                üìß Signing in as: <strong>${savedEmail}</strong>
                <button
                  onclick="localStorage.removeItem('sage_stocks_user_email'); window.location.reload();"
                  class="ml-2 text-xs text-blue-600 hover:text-blue-700 underline"
                >
                  Change email
                </button>
              </p>
            </div>
          ` : ''}

          <p class="text-sm text-gray-600 mb-4">
            By signing in, you authorize Sage Stocks to create and write to a template in your Notion workspace.
          </p>
          <button
            id="signin-button"
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <img src="/notion-logo.png" alt="Notion" class="w-5 h-5 mr-2" onerror="this.style.display='none'" />
            Sign in with Notion
          </button>
        </div>
      </div>
    </div>
  `;

  // Setup event listeners after render
  setTimeout(() => {
    const emailInput = section.querySelector('#user-email-input');
    const signinButton = section.querySelector('#signin-button');
    const emailError = section.querySelector('#email-error');

    if (signinButton) {
      signinButton.addEventListener('click', async () => {
        // If we need email input, validate it first
        if (needsEmailInput && emailInput) {
          const email = emailInput.value.trim();

          // Basic email validation
          if (!email || !email.includes('@') || !email.includes('.')) {
            if (emailError) {
              emailError.textContent = 'Please enter a valid email address';
              emailError.classList.remove('hidden');
            }
            emailInput.focus();
            return;
          }

          if (emailError) {
            emailError.classList.add('hidden');
          }

          // Disable button and show loading
          signinButton.disabled = true;
          signinButton.innerHTML = '<span class="inline-block spinner mr-2" style="width: 16px; height: 16px; border: 2px solid white; border-top-color: transparent; border-radius: 50%;"></span> Verifying...';

          // Call handleSetupStart with email (v1.2.14)
          await handleSetupStart(email);
        } else {
          // No email needed, proceed directly (v1.2.14)
          await handleSetupStart();
        }
      });

      // Allow Enter key to submit
      if (emailInput) {
        emailInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            signinButton.click();
          }
        });
      }
    }
  }, 0);

  return section;
}

// ============================================================================
// Step 1.5: Manual Template Setup (BEFORE OAuth)
// ============================================================================

function renderStep1_5Content() {
  const contentDiv = document.querySelector('#setup-content');
  if (!contentDiv) return;

  const savedEmail = localStorage.getItem('sage_stocks_user_email');

  contentDiv.innerHTML = `
    <div class="slide-in">
      <div class="mb-6 p-6 rounded-lg border bg-blue-50 border-blue-200">
        <div class="flex items-start">
          <div class="text-3xl mr-4">üìÑ</div>
          <div class="flex-1">
            <h3 class="font-bold text-gray-900 text-xl mb-2">Set Up Your Workspace</h3>
            <p class="text-gray-700 mb-4">
              Before connecting to Notion, let's set up your workspace template.
            </p>

            <!-- Tutorial GIF Placeholder -->
            <div class="mb-6 aspect-video bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center relative overflow-hidden group">
              <div class="text-center p-6">
                <div class="text-4xl mb-2">üé¨</div>
                <p class="text-gray-500 font-medium">Tutorial GIF Placeholder</p>
                <p class="text-xs text-gray-400 mt-1">Shows: Open Template ‚Üí Click Duplicate ‚Üí Close Tab</p>
              </div>
              <!-- Hover overlay to hint at future content -->
              <div class="absolute inset-0 bg-black bg-opacity-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <p class="text-xs text-gray-600 font-medium bg-white px-3 py-1 rounded-full shadow-sm">Animation coming soon</p>
              </div>
            </div>

            <div class="mb-4 p-4 bg-white border border-blue-200 rounded-lg">
              <p class="text-sm font-medium text-gray-800 mb-3">
                üìñ <strong>Instructions:</strong>
              </p>
              <ol class="text-sm text-gray-700 space-y-2 ml-4 list-decimal">
                <li>Click "Open Template in Notion" below</li>
                <li>Notion will open in a new tab</li>
                <li>Click the <strong>"Duplicate"</strong> button in the top-right corner of Notion</li>
                <li>Return to this tab and click "Continue to Connect Notion"</li>
              </ol>
            </div>

            ${savedEmail ? `
              <p class="text-sm text-gray-600 mb-4">
                Setting up for: <strong>${savedEmail}</strong>
              </p>
            ` : ''}

            <div class="flex flex-col sm:flex-row gap-3">
              <a
                href="#"
                id="open-template-button"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-6 py-3 bg-white border-2 border-blue-600 text-blue-600 font-semibold rounded-lg hover:bg-blue-50 transition-all"
              >
                üìÑ Open Template in Notion
              </a>
              <button
                id="continue-to-oauth"
                disabled
                class="inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
              >
                Continue to Connect Notion ‚Üí
              </button>
            </div>

            <div class="mt-4 mb-4">
              <label class="flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                <input type="checkbox" id="confirm-duplicate" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                <span class="text-sm font-medium text-gray-700">I have duplicated the template in Notion</span>
              </label>
            </div>

            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <p class="text-xs text-yellow-800">
                ‚ö†Ô∏è <strong>Important:</strong> You must duplicate the template before continuing, otherwise the setup will fail.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  // Setup event listeners
  setTimeout(async () => {
    const openTemplateButton = document.querySelector('#open-template-button');
    const continueButton = document.querySelector('#continue-to-oauth');

    // Get template URL
    try {
      const response = await fetch('/api/setup/template-url');
      const data = await response.json();

      if (data.success && openTemplateButton) {
        openTemplateButton.href = data.url;
      }
    } catch (error) {
      console.error('‚ùå Failed to get template URL:', error);
    }

    // Enable "Continue" button ONLY when checkbox is checked
    const confirmCheckbox = document.querySelector('#confirm-duplicate');

    if (confirmCheckbox && continueButton) {
      confirmCheckbox.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        continueButton.disabled = !isChecked;

        if (isChecked) {
          continueButton.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed', 'disabled:shadow-none');
          console.log('‚úÖ User confirmed duplication - enabling Continue button');
        } else {
          continueButton.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed', 'disabled:shadow-none');
          console.log('‚ùå User unchecked confirmation - disabling Continue button');
        }
      });
    }

    // Continue to OAuth button
    if (continueButton) {
      continueButton.addEventListener('click', () => {
        if (continueButton.disabled) return;

        console.log('‚úÖ User proceeding to OAuth');
        const email = localStorage.getItem('sage_stocks_user_email');
        proceedToOAuth(email);
      });
    }
  }, 0);
}

// ============================================================================
// Step 2: Duplicate Template (Manual Flow)
// ============================================================================

/**
 * Step 2: Verify Workspace (v1.2.14)
 *
 * Runs AFTER OAuth callback. Verifies that the user has a Sage Stocks template
 * in their workspace (either from Step 1.5 manual duplication or from being
 * an existing user).
 */
function createStep2Content() {
  const section = document.createElement('div');
  section.className = 'slide-in';

  section.innerHTML = `
    <div class="mb-6 p-6 rounded-lg border bg-green-50 border-green-200">
      <div class="flex items-start">
        <div class="text-3xl mr-4">‚úÖ</div>
        <div class="flex-1">
          <h3 class="font-bold text-gray-900 text-xl mb-2">Step 2 of 3: Verify Your Workspace</h3>

          <!-- Checking State -->
          <div id="step2-checking">
            <p class="text-gray-700 mb-4">
              Verifying your Notion workspace...
            </p>
            <div class="flex items-center gap-2">
              <span class="inline-block spinner" style="width: 20px; height: 20px; border: 3px solid #3B82F6; border-top-color: transparent; border-radius: 50%;"></span>
              <span class="text-sm text-gray-600">This will only take a moment</span>
            </div>
          </div>

          <!-- Workspace Verified -->
          <div id="step2-verified" class="hidden">
            <div class="p-4 bg-green-100 border-2 border-green-300 rounded-lg mb-4">
              <p class="text-green-800 font-medium mb-2">‚úÖ Workspace Verified!</p>
              <p class="text-sm text-green-700">Your Sage Stocks workspace is set up and ready to use.</p>
            </div>
            <button
              id="step2-continue"
              class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg hover:shadow-xl"
            >
              Continue to Final Step ‚Üí
            </button>
          </div>

          <!-- Workspace Not Found (Error State) -->
          <div id="step2-error" class="hidden">
            <div class="p-4 bg-red-100 border-2 border-red-300 rounded-lg mb-4">
              <p class="text-red-800 font-medium mb-2">‚ùå Workspace Not Found</p>
              <p class="text-sm text-red-700 mb-3">
                We couldn't find a Sage Stocks workspace in your Notion account. This may be because:
              </p>
              <ul class="text-sm text-red-700 space-y-1 ml-4 list-disc">
                <li>You didn't duplicate the template in the previous step</li>
                <li>The duplication is still in progress (rare, but can take a moment)</li>
                <li>You used a different Notion account than expected</li>
              </ul>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
              <button
                id="step2-retry"
                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl"
              >
                üîÑ Check Again
              </button>
              <button
                id="step2-restart"
                class="px-6 py-3 bg-white border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition-all"
              >
                ‚Üê Start Over
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  `;

  // Setup event listeners after render
  setTimeout(async () => {
    const checkingDiv = section.querySelector('#step2-checking');
    const verifiedDiv = section.querySelector('#step2-verified');
    const errorDiv = section.querySelector('#step2-error');
    const continueButton = section.querySelector('#step2-continue');
    const retryButton = section.querySelector('#step2-retry');
    const restartButton = section.querySelector('#step2-restart');

    // Function to check for template
    async function checkForTemplate() {
      try {
        console.log('üîç Verifying Sage Stocks workspace...');
        const response = await fetch('/api/setup/check-template');
        const data = await response.json();

        if (checkingDiv) checkingDiv.classList.add('hidden');

        if (data.hasTemplate) {
          console.log('‚úÖ Workspace verified:', data.templateId);
          if (verifiedDiv) verifiedDiv.classList.remove('hidden');
        } else {
          console.warn('‚ùå No workspace found - user may not have duplicated template');
          if (errorDiv) errorDiv.classList.remove('hidden');
        }
      } catch (error) {
        console.error('‚ùå Failed to verify workspace:', error);
        if (checkingDiv) checkingDiv.classList.add('hidden');
        if (errorDiv) errorDiv.classList.remove('hidden');
      }
    }

    // Initial check
    await checkForTemplate();

    // Continue button
    if (continueButton) {
      continueButton.addEventListener('click', async () => {
        await advanceToStep(3, { step2Complete: true });
      });
    }

    // Retry button
    if (retryButton) {
      retryButton.addEventListener('click', async () => {
        // Hide error, show checking
        if (errorDiv) errorDiv.classList.add('hidden');
        if (checkingDiv) checkingDiv.classList.remove('hidden');

        // Check again
        await checkForTemplate();
      });
    }

    // Restart button
    if (restartButton) {
      restartButton.addEventListener('click', () => {
        // Clear everything and start over
        localStorage.removeItem('sage_stocks_user_email');
        window.location.href = '/';
      });
    }
  }, 0);

  return section;
}
// ============================================================================
// Step 3: Run First Analysis
// ============================================================================

function createStep3Content() {
  const section = document.createElement('div');
  section.className = 'slide-in';
  section.innerHTML = `
    <div class="mb-6 p-6 rounded-lg border bg-indigo-50 border-indigo-200">
      <div class="flex items-start">
        <div class="text-3xl mr-4">üìä</div>
        <div class="flex-1">
          <h3 class="font-bold text-gray-900 text-xl mb-2">Step 3 of 3: Run Your First Analysis</h3>
          <p class="text-gray-700 mb-4">
            Your workspace is ready! Enter any ticker symbol (like AAPL, TSLA, or GOOGL) and we'll generate a comprehensive analysis in your Notion workspace.
          </p>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2 text-gray-700">Enter Ticker Symbol</label>
            <input
              type="text"
              id="ticker-input"
              placeholder="e.g., AAPL"
              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all uppercase"
              maxlength="10"
            />
          </div>
          <button
            id="analyze-button"
            disabled
            class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
          >
            üìä Analyze Stock
          </button>
          <div id="analysis-status" class="hidden mt-4"></div>
        </div>
      </div>
    </div>
  `;

  // Setup event listeners
  setTimeout(() => {
    const input = section.querySelector('#ticker-input');
    const button = section.querySelector('#analyze-button');

    if (input && button) {
      input.addEventListener('input', () => {
        button.disabled = input.value.trim().length < 1;
      });

      button.addEventListener('click', async () => {
        await runFirstAnalysis(input.value.trim().toUpperCase());
      });

      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && input.value.trim().length >= 1) {
          runFirstAnalysis(input.value.trim().toUpperCase());
        }
      });
    }
  }, 0);

  return section;
}

async function runFirstAnalysis(ticker) {
  const button = document.getElementById('analyze-button');
  const statusDiv = document.getElementById('analysis-status');

  if (!button || !statusDiv) return;

  button.disabled = true;
  button.innerHTML = '<span class="inline-block spinner mr-2" style="width: 16px; height: 16px; border: 2px solid white; border-top-color: transparent; border-radius: 50%;"></span> Starting analysis...';

  statusDiv.classList.remove('hidden');
  statusDiv.innerHTML = `
    <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
      <p class="text-blue-800 font-medium">üöÄ Starting analysis for ${ticker}...</p>
      <p class="text-sm text-blue-700 mt-1">This will take 60-140 seconds. Hang tight!</p>
    </div>
  `;

  try {
    // Detect user's timezone automatically
    const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    const response = await fetch('/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ticker,
        timezone: userTimezone,
      }),
    });

    const data = await response.json();

    if (!response.ok || !data.success) {
      // Extract error message properly - handle object errors
      const errorMsg = typeof data.error === 'string'
        ? data.error
        : (data.error?.message || data.message || JSON.stringify(data.error) || 'Analysis failed');
      throw new Error(errorMsg);
    }

    // üéâ CONFETTI TIME!
    confetti({
      particleCount: 100,
      spread: 70,
      origin: { y: 0.6 }
    });

    // Mark step 3 as complete and setup as complete
    if (!currentState.completedSteps.includes(3)) {
      currentState.completedSteps.push(3);
      renderSubwayMap();
    }
    currentState.setupComplete = true;

    // Build Notion URLs
    const analysisUrl = data.analysesPageId ? `https://notion.so/${data.analysesPageId.replace(/-/g, '')}` : null;
    const workspaceUrl = data.sageStocksPageId ? `https://notion.so/${data.sageStocksPageId.replace(/-/g, '')}` : null;

    statusDiv.innerHTML = `
      <div class="p-6 bg-green-50 border-2 border-green-300 rounded-lg">
        <p class="text-green-800 font-bold text-lg mb-3">üéâ Setup Complete!</p>
        <p class="text-sm text-green-700 mb-4">
          Your first analysis for <strong>${ticker}</strong> is ready in Notion. You can now access your workspace anytime.
        </p>

        <div class="flex flex-col sm:flex-row gap-3 mb-4">
          ${analysisUrl ? `
            <a
              href="${analysisUrl}"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 text-center"
            >
              üìÑ View This Analysis ‚Üí
            </a>
          ` : ''}
          ${workspaceUrl ? `
            <a
              href="${workspaceUrl}"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 text-center"
            >
              üìä View Sage Stocks Workspace ‚Üí
            </a>
          ` : ''}
        </div>

        <div class="text-sm text-gray-700 bg-white p-4 rounded-lg border border-green-200">
          <p class="font-medium mb-2">What's next?</p>
          <ul class="ml-4 list-disc space-y-1">
            <li>Access your Stock Analyses and History databases</li>
            <li>View AI-generated insights and recommendations</li>
            <li>Run more analyses from the <a href="/analyze.html" class="text-blue-600 hover:underline">analyzer page</a></li>
          </ul>
        </div>
      </div>
    `;

  } catch (error) {
    console.error('‚ùå Analysis failed:', error);

    // Extract error message properly
    const errorMessage = error.message || (typeof error === 'string' ? error : 'An unexpected error occurred');

    statusDiv.innerHTML = `
      <div class="p-4 bg-red-50 border-l-4 border-red-400 rounded">
        <p class="text-red-800 font-medium mb-1">‚ùå Analysis failed</p>
        <p class="text-sm text-red-700">${errorMessage}</p>
        <button
          id="retry-analysis"
          class="mt-3 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-all"
        >
          Try Again
        </button>
      </div>
    `;

    button.disabled = false;
    button.innerHTML = 'üìä Analyze Stock';

    // Setup retry button
    const retryBtn = statusDiv.querySelector('#retry-analysis');
    if (retryBtn) {
      retryBtn.addEventListener('click', () => {
        runFirstAnalysis(ticker);
      });
    }
  }
}

// ============================================================================
// Step 5: View Results
// ============================================================================

function createStep5Content() {
  const section = document.createElement('div');
  section.className = 'slide-in';

  const analysisUrl = currentState.setupProgress?.step5AnalysisUrl || '#';
  const ticker = currentState.setupProgress?.step4FirstTicker || 'your stock';

  section.innerHTML = `
    <div class="mb-6 p-6 rounded-lg border bg-purple-50 border-purple-200">
      <div class="text-center py-8">
        <div class="text-6xl mb-4">üéâ</div>
        <h3 class="font-bold text-gray-900 text-2xl mb-2">Almost There!</h3>
        <p class="text-gray-700 text-lg mb-6">
          Your analysis for <strong>${ticker}</strong> is ready in your Notion workspace!
        </p>
        <button
          onclick="window.open('${analysisUrl}', '_blank'); document.getElementById('mark-complete').classList.remove('hidden');"
          class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg hover:shadow-xl text-lg"
        >
          üëÅÔ∏è Open Analysis in Notion
        </button>
        <div id="mark-complete" class="hidden mt-6">
          <p class="text-sm text-gray-600 mb-3">Seen your analysis? Let's finish setup!</p>
          <button
            onclick="completeSetup()"
            class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-all"
          >
            ‚úì I've Viewed My Analysis - Complete Setup
          </button>
        </div>
      </div>
    </div>
  `;

  return section;
}

async function completeSetup() {
  // Set localStorage flag to prevent duplicate templates on re-authentication
  localStorage.setItem('sage_stocks_setup_complete', 'true');
  console.log('‚úÖ Setup complete flag set in localStorage');

  await advanceToStep(6);
}

// ============================================================================
// Step 6: Complete!
// ============================================================================

function createStep6Content() {
  const section = document.createElement('div');
  section.className = 'slide-in';
  section.innerHTML = `
    <div class="mb-6 p-6 rounded-lg border bg-green-50 border-green-200">
      <div class="text-center py-12">
        <div class="text-7xl mb-4">üéâ</div>
        <h3 class="font-bold text-gray-900 text-3xl mb-3">You're All Set!</h3>
        <p class="text-gray-700 text-lg mb-6">
          Your Sage Stocks workspace is fully configured and ready for daily analysis.
        </p>
        <div class="bg-white border border-green-200 rounded-xl p-6 max-w-md mx-auto mb-6">
          <div class="space-y-3 text-left">
            <p class="text-green-800 flex items-center gap-2">
              <span class="font-medium">‚úì</span> Template duplicated and connected
            </p>
            <p class="text-green-800 flex items-center gap-2">
              <span class="font-medium">‚úì</span> Databases auto-detected and verified
            </p>
            <p class="text-green-800 flex items-center gap-2">
              <span class="font-medium">‚úì</span> First analysis completed
            </p>
          </div>
        </div>
        <p class="text-sm text-gray-600 mb-4">Redirecting to your analyzer in <span id="countdown">3</span> seconds...</p>
        <button
          onclick="window.location.href='/analyze.html'"
          class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl text-lg"
        >
          Go to Analyzer Now ‚Üí
        </button>
      </div>
    </div>
  `;

  // Countdown redirect
  let countdown = 3;
  const countdownEl = document.getElementById('countdown');
  const interval = setInterval(() => {
    countdown--;
    if (countdownEl) {
      countdownEl.textContent = countdown;
    }
    if (countdown <= 0) {
      clearInterval(interval);
      window.location.href = '/analyze.html';
    }
  }, 1000);

  return section;
}

// ============================================================================
// Error Handling & UI Helpers
// ============================================================================

function showError(message) {
  const container = document.getElementById('setup-content');
  if (!container) return;

  const errorDiv = document.createElement('div');
  errorDiv.className = 'bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded slide-in';
  errorDiv.innerHTML = `
    <div class="flex items-start gap-3">
      <span class="text-red-600 text-xl flex-shrink-0">‚ö†Ô∏è</span>
      <div class="flex-1">
        <p class="font-medium text-red-800">Error</p>
        <p class="text-sm text-red-700 mt-1">${message}</p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="text-red-600 hover:text-red-800 flex-shrink-0">
        ‚úï
      </button>
    </div>
  `;

  container.insertBefore(errorDiv, container.firstChild);
}

function showStatusMessage(status) {
  const container = document.getElementById('setup-content');
  if (!container) return;

  const messages = {
    pending: {
      icon: '‚è≥',
      title: 'Account Pending Approval',
      message: 'Your account has been created and is awaiting admin approval. You\'ll receive an email when approved (usually within 24 hours). Once approved, refresh this page to continue.',
      color: 'yellow'
    },
    denied: {
      icon: '‚ùå',
      title: 'Access Denied',
      message: 'Your account application has been denied. Please contact support if you believe this is an error.',
      color: 'red'
    }
  };

  const msg = messages[status];
  if (!msg) return;

  container.innerHTML = `
    <div class="p-6 bg-${msg.color}-50 border border-${msg.color}-200 rounded-lg">
      <div class="flex items-start gap-4">
        <div class="text-3xl">${msg.icon}</div>
        <div class="flex-1">
          <p class="text-${msg.color}-800 font-medium text-lg">${msg.title}</p>
          <p class="text-${msg.color}-700 text-sm mt-1">${msg.message}</p>
          ${status === 'pending' ? `
            <button
              onclick="window.location.reload()"
              class="mt-4 px-4 py-2 bg-${msg.color}-600 text-white font-semibold rounded-lg hover:bg-${msg.color}-700 transition-all"
            >
              üîÑ Refresh Status
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `;
}

function getErrorMessage(errorCode) {
  const messages = {
    'access_denied': 'You denied access to your Notion workspace. Please try again and grant access.',
    'missing_code': 'Authorization code missing. Please try signing in again.',
    'server_config': 'Server configuration error. Please contact support.',
    'token_exchange_failed': 'Failed to complete authentication. Please try again.',
    'oauth_failed': 'Authentication failed. Please try again or contact support.',
    'unknown_status': 'Unexpected error occurred. Please contact support.',
  };

  return messages[errorCode] || 'An error occurred during setup. Please try again.';
}

// Make functions globally accessible for inline onclick handlers
window.completeSetup = completeSetup;
