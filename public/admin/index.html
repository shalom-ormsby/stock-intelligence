<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sage Stocks</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Top Nav Bar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <span class="text-xl font-bold text-gray-900">⛰️ Sage Stocks</span>
                <span class="text-sm bg-red-100 text-red-700 font-medium px-3 py-1 rounded">ADMIN</span>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">
                    <span class="font-medium" id="admin-email">Loading...</span>
                </span>
                <a href="/analyze.html" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium py-2 px-4 rounded transition duration-200">
                    Analyzer
                </a>
                <button
                    onclick="window.location.href='/api/auth/logout'"
                    class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded transition duration-200"
                >
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Admin Dashboard</h1>
            <p class="text-gray-600">Manage users and monitor system activity</p>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading dashboard...</p>
        </div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="main-content" class="hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-600 mb-1">Total Users</div>
                    <div class="text-3xl font-bold text-gray-900" id="stat-total">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-600 mb-1">Pending Approval</div>
                    <div class="text-3xl font-bold text-yellow-600" id="stat-pending">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-600 mb-1">Approved Users</div>
                    <div class="text-3xl font-bold text-green-600" id="stat-approved">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-600 mb-1">Analyses Today</div>
                    <div class="text-3xl font-bold text-blue-600" id="stat-analyses">0</div>
                </div>
            </div>

            <!-- User Management Section -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">User Management</h2>
                    <div class="flex items-center space-x-3">
                        <button
                            onclick="loadData()"
                            class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded transition duration-200"
                        >
                            Refresh
                        </button>
                        <a
                            href="https://notion.so/8feec24b5d45420cb34e7891caaf3d20"
                            target="_blank"
                            class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium py-2 px-4 rounded transition duration-200"
                        >
                            View in Notion →
                        </a>
                    </div>
                </div>

                <!-- User Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Analyses</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Signup Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-12">
                    <p class="text-gray-500">No users found</p>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                <p class="text-red-800 font-medium mb-2">Access Denied</p>
                <p class="text-red-700 text-sm">You do not have admin access to this dashboard.</p>
                <a href="/analyze.html" class="mt-4 inline-block text-blue-600 hover:underline">Go to Analyzer</a>
            </div>
        </div>
    </div>

    <script>
        let users = [];
        let stats = {};

        // Check authentication and load data
        async function init() {
            try {
                // Check if user is authenticated
                const sessionRes = await fetch('/api/auth/session');
                const sessionData = await sessionRes.json();

                if (!sessionData.authenticated) {
                    window.location.href = '/';
                    return;
                }

                document.getElementById('admin-email').textContent = sessionData.user.email;

                // Load dashboard data
                await loadData();
            } catch (error) {
                console.error('Init error:', error);
                showError();
            }
        }

        async function loadData() {
            try {
                // Fetch stats and users in parallel
                const [statsRes, usersRes] = await Promise.all([
                    fetch('/api/admin/stats'),
                    fetch('/api/admin/users')
                ]);

                // Check if admin (will get 403 if not)
                if (statsRes.status === 403 || usersRes.status === 403) {
                    showError();
                    return;
                }

                const statsData = await statsRes.json();
                const usersData = await usersRes.json();

                if (!statsData.success || !usersData.success) {
                    throw new Error('Failed to load data');
                }

                stats = statsData.stats;
                users = usersData.users;

                renderStats();
                renderUsers();

                // Show main content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } catch (error) {
                console.error('Load data error:', error);
                showError();
            }
        }

        function renderStats() {
            document.getElementById('stat-total').textContent = stats.totalUsers;
            document.getElementById('stat-pending').textContent = stats.pendingUsers;
            document.getElementById('stat-approved').textContent = stats.approvedUsers;
            document.getElementById('stat-analyses').textContent = stats.totalAnalysesToday;
        }

        function renderUsers() {
            const tbody = document.getElementById('user-table-body');
            const emptyState = document.getElementById('empty-state');

            if (users.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            tbody.innerHTML = users.map(user => {
                const statusColors = {
                    pending: 'bg-yellow-100 text-yellow-800',
                    approved: 'bg-green-100 text-green-800',
                    denied: 'bg-red-100 text-red-800',
                };

                const statusColor = statusColors[user.status] || 'bg-gray-100 text-gray-800';
                const signupDate = new Date(user.signupDate).toLocaleDateString();

                return `
                    <tr>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${escapeHtml(user.name)}</div>
                            <div class="text-sm text-gray-500">${escapeHtml(user.email)}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                ${user.status}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${user.totalAnalyses} total</div>
                            <div class="text-sm text-gray-500">${user.dailyAnalyses} today</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${signupDate}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                ${user.status !== 'approved' ? `
                                    <button
                                        onclick="updateStatus('${user.id}', 'approved')"
                                        class="text-xs bg-green-100 hover:bg-green-200 text-green-700 font-medium py-1 px-3 rounded transition duration-200"
                                    >
                                        Approve
                                    </button>
                                ` : ''}
                                ${user.status !== 'denied' ? `
                                    <button
                                        onclick="updateStatus('${user.id}', 'denied')"
                                        class="text-xs bg-red-100 hover:bg-red-200 text-red-700 font-medium py-1 px-3 rounded transition duration-200"
                                    >
                                        Deny
                                    </button>
                                ` : ''}
                                ${user.status !== 'pending' ? `
                                    <button
                                        onclick="updateStatus('${user.id}', 'pending')"
                                        class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-1 px-3 rounded transition duration-200"
                                    >
                                        Reset
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function updateStatus(userId, newStatus) {
            if (!confirm(`Are you sure you want to set this user's status to "${newStatus}"?`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId,
                        status: newStatus,
                    }),
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Failed to update status');
                }

                // Reload data
                await loadData();

                alert(`User status updated to "${newStatus}" successfully!`);
            } catch (error) {
                console.error('Update status error:', error);
                alert('Failed to update user status. Please try again.');
            }
        }

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
