<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>List Templates - Sage Stocks</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto mt-8">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <div class="text-center">
        <div class="text-5xl mb-3">üìö</div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">All Sage Stocks Templates</h1>
        <p class="text-gray-600">See all Sage Stocks databases in your workspace</p>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-2xl shadow-xl p-8 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-gray-600">Searching your workspace...</p>
    </div>

    <!-- Results -->
    <div id="results" class="hidden space-y-6">
      <!-- Summary -->
      <div id="summary" class="bg-white rounded-2xl shadow-xl p-6"></div>

      <!-- Sage Stocks Pages -->
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üìÑ Sage Stocks Pages</h2>
        <div id="pages-content"></div>
      </div>

      <!-- Stock Analyses Databases -->
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üìä Stock Analyses Databases</h2>
        <div id="analyses-content"></div>
      </div>

      <!-- Stock History Databases -->
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üìà Stock History Databases</h2>
        <div id="history-content"></div>
      </div>

      <!-- Actions -->
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üõ†Ô∏è Actions</h2>
        <div class="space-y-3">
          <a href="/validate.html" class="block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 text-center font-medium">
            Validate Configuration
          </a>
          <a href="/setup.html" class="block bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 text-center font-medium">
            Re-run Setup
          </a>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-white rounded-2xl shadow-xl p-8">
      <div class="text-center">
        <div class="text-5xl mb-3">‚ö†Ô∏è</div>
        <h2 class="text-2xl font-bold text-red-900 mb-2">Error</h2>
        <p id="error-message" class="text-gray-600 mb-4"></p>
        <a href="/" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium inline-block">
          Go to Home
        </a>
      </div>
    </div>
  </div>

  <script>
    async function listTemplates() {
      try {
        const response = await fetch('/api/debug/list-templates');
        const data = await response.json();

        document.getElementById('loading').classList.add('hidden');

        if (!response.ok) {
          document.getElementById('error').classList.remove('hidden');
          document.getElementById('error-message').textContent = data.error || 'Failed to list templates';
          return;
        }

        document.getElementById('results').classList.remove('hidden');

        // Summary
        const summary = document.getElementById('summary');
        const hasDuplicates = data.summary?.hasDuplicates;
        summary.innerHTML = `
          <div class="text-center">
            <div class="text-6xl mb-3">${hasDuplicates ? '‚ö†Ô∏è' : '‚úÖ'}</div>
            <h3 class="text-2xl font-bold mb-4">${hasDuplicates ? 'Duplicates Found' : 'No Duplicates'}</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
              <div>
                <div class="text-3xl font-bold text-gray-900">${data.summary?.totalSageStocksPages || 0}</div>
                <div class="text-sm text-gray-600">Sage Stocks Pages</div>
              </div>
              <div>
                <div class="text-3xl font-bold text-gray-900">${data.summary?.totalStockAnalysesDbs || 0}</div>
                <div class="text-sm text-gray-600">Stock Analyses DBs</div>
              </div>
              <div>
                <div class="text-3xl font-bold text-gray-900">${data.summary?.totalStockHistoryDbs || 0}</div>
                <div class="text-sm text-gray-600">Stock History DBs</div>
              </div>
            </div>
          </div>
        `;

        // Pages
        const pagesContent = document.getElementById('pages-content');
        if (data.foundInWorkspace?.sageStocksPages?.length > 0) {
          pagesContent.innerHTML = data.foundInWorkspace.sageStocksPages.map(page => `
            <div class="bg-gray-50 p-4 rounded-lg mb-3 ${page.isStored ? 'border-2 border-green-500' : ''}">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  ${page.isStored ? '<span class="text-2xl">‚úÖ</span>' : '<span class="text-2xl">üìÑ</span>'}
                  <span class="font-semibold">${page.title}</span>
                  ${page.isStored ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">CONFIGURED</span>' : ''}
                </div>
              </div>
              <div class="text-sm text-gray-600 ml-9">
                <div class="font-mono text-xs mb-1">${page.id}</div>
                <div>Created: ${new Date(page.createdTime).toLocaleString()}</div>
                <a href="${page.url}" target="_blank" class="text-blue-600 hover:underline">Open in Notion ‚Üí</a>
              </div>
            </div>
          `).join('');
        } else {
          pagesContent.innerHTML = '<p class="text-gray-500 text-center py-4">No Sage Stocks pages found</p>';
        }

        // Stock Analyses
        const analysesContent = document.getElementById('analyses-content');
        if (data.foundInWorkspace?.stockAnalysesDatabases?.length > 0) {
          analysesContent.innerHTML = data.foundInWorkspace.stockAnalysesDatabases.map(db => `
            <div class="bg-gray-50 p-4 rounded-lg mb-3 ${db.isStored ? 'border-2 border-green-500' : ''}">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  ${db.isStored ? '<span class="text-2xl">‚úÖ</span>' : '<span class="text-2xl">üìä</span>'}
                  <span class="font-semibold">${db.title}</span>
                  ${db.isStored ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">CONFIGURED</span>' : ''}
                </div>
              </div>
              <div class="text-sm text-gray-600 ml-9">
                <div class="font-mono text-xs mb-1">${db.id}</div>
                <div>Created: ${new Date(db.createdTime).toLocaleString()}</div>
                <a href="${db.url}" target="_blank" class="text-blue-600 hover:underline">Open in Notion ‚Üí</a>
              </div>
            </div>
          `).join('');
        } else {
          analysesContent.innerHTML = '<p class="text-gray-500 text-center py-4">No Stock Analyses databases found</p>';
        }

        // Stock History
        const historyContent = document.getElementById('history-content');
        if (data.foundInWorkspace?.stockHistoryDatabases?.length > 0) {
          historyContent.innerHTML = data.foundInWorkspace.stockHistoryDatabases.map(db => `
            <div class="bg-gray-50 p-4 rounded-lg mb-3 ${db.isStored ? 'border-2 border-green-500' : ''}">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  ${db.isStored ? '<span class="text-2xl">‚úÖ</span>' : '<span class="text-2xl">üìà</span>'}
                  <span class="font-semibold">${db.title}</span>
                  ${db.isStored ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">CONFIGURED</span>' : ''}
                </div>
              </div>
              <div class="text-sm text-gray-600 ml-9">
                <div class="font-mono text-xs mb-1">${db.id}</div>
                <div>Created: ${new Date(db.createdTime).toLocaleString()}</div>
                <a href="${db.url}" target="_blank" class="text-blue-600 hover:underline">Open in Notion ‚Üí</a>
              </div>
            </div>
          `).join('');
        } else {
          historyContent.innerHTML = '<p class="text-gray-500 text-center py-4">No Stock History databases found</p>';
        }

      } catch (error) {
        console.error('List templates error:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error-message').textContent = error.message || 'Failed to list templates';
      }
    }

    listTemplates();
  </script>
</body>
</html>
