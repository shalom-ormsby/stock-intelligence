<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Intelligence - Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-inactive { background-color: #9ca3af; }

        .api-card {
            transition: all 0.2s ease;
        }
        .api-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Top Nav Bar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <span class="text-xl font-bold text-gray-900">✨ Stock Intelligence</span>
                <a href="/settings.html" class="text-sm text-gray-600 hover:text-gray-900 transition duration-200">
                    Settings
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">
                    <span class="font-medium" id="user-email">Loading...</span>
                </span>
                <button
                    onclick="window.location.href='/api/auth/logout'"
                    class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded transition duration-200"
                >
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Analyze Stock</h1>
            <p class="text-gray-600">Enter a ticker symbol to get AI-powered analysis</p>
        </div>

        <!-- Main Analyzer Section -->
        <div id="analyzer-section" class="bg-white rounded-lg shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Analyze Stock</h2>

            <!-- Ticker Input -->
            <div class="mb-6">
                <label for="ticker" class="block text-sm font-medium text-gray-700 mb-2">
                    Stock Ticker
                </label>
                <input
                    type="text"
                    id="ticker"
                    placeholder="e.g., AAPL, MSFT, NVDA"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase"
                    maxlength="10"
                />
            </div>

            <!-- Analyze Button -->
            <button
                id="analyze-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
            >
                Analyze Stock
            </button>

            <!-- Status Display -->
            <div id="status-display" class="mt-6 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
                        <p class="text-blue-800 font-medium" id="status-text">Initializing analysis...</p>
                    </div>
                </div>
            </div>

            <!-- Results Display -->
            <div id="results-display" class="mt-6 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-green-800 mb-3">Analysis Complete!</h3>
                    <a
                        id="results-link"
                        href="#"
                        target="_blank"
                        class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200"
                    >
                        View Results in Notion →
                    </a>
                </div>
            </div>

            <!-- Error Display -->
            <div id="error-display" class="mt-6 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-blue-800 whitespace-pre-line" id="error-text"></p>
                </div>
            </div>

            <!-- Usage Counter -->
            <div class="mt-6 text-center text-sm text-gray-600">
                <span id="usage-counter">Analyses today: <span class="font-semibold">0/10</span></span>
            </div>
        </div>

        <!-- Admin Panel (Hidden by default, shown with ?admin=true) -->
        <div id="admin-panel" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">API Management Dashboard</h2>
                    <button
                        id="refresh-apis"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg text-sm transition duration-200"
                    >
                        Refresh
                    </button>
                </div>

                <!-- Loading State -->
                <div id="admin-loading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading API status...</p>
                </div>

                <!-- API Status Cards -->
                <div id="api-status-container" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="api-cards">
                        <!-- API cards will be inserted here dynamically -->
                    </div>

                    <!-- Daily Cost Summary -->
                    <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Daily Cost Summary</h3>
                        <div id="cost-summary" class="space-y-2 text-sm">
                            <!-- Cost details will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Last Updated -->
                <div class="mt-6 text-center text-sm text-gray-500">
                    Last updated: <span id="last-updated">Never</span>
                    <span class="mx-2">•</span>
                    Auto-refresh every 30s
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/session');
                const data = await response.json();

                if (!data.authenticated) {
                    // Not authenticated - redirect to landing page
                    window.location.href = '/';
                    return false;
                }

                // Show user email in nav
                document.getElementById('user-email').textContent = data.user.email;
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
                return false;
            }
        }

        // Run auth check immediately
        checkAuth();

        // Check for admin parameter
        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.get('admin') === 'true';

        if (isAdmin) {
            document.getElementById('admin-panel').classList.remove('hidden');
            loadAPIStatus();
            // Auto-refresh every 30 seconds
            setInterval(loadAPIStatus, 30000);
        }

        // Analyze button handler
        document.getElementById('analyze-btn').addEventListener('click', async () => {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();

            if (!ticker) {
                showError('Please enter a stock ticker');
                return;
            }

            if (!/^[A-Z0-9-]{1,10}$/.test(ticker)) {
                showError('Invalid ticker format. Use 1-10 alphanumeric characters and hyphens.');
                return;
            }

            // Reset displays
            hideAll();
            showStatus('Analyzing ' + ticker + '...');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticker: ticker,
                        // userId will be extracted from session by the API
                    }),
                });

                // Check if response is JSON before parsing
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // Response is not JSON - read as text for error message
                    const text = await response.text();
                    const preview = text.substring(0, 200);
                    console.error('Non-JSON response from server:', preview);
                    showError(`Server error (${response.status}): ${preview.replace(/<[^>]*>/g, '').trim()}`);
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    showResults(data.analysesPageId);
                    updateUsageCounter(data.rateLimit);
                } else {
                    // Show actual error message from backend
                    const errorMsg = data.error?.message || data.error || 'Analysis failed';
                    showError(errorMsg);
                }
            } catch (error) {
                console.error('Analysis request failed:', error);
                showError('Request failed: ' + error.message);
            }
        });

        // Refresh button handler
        document.getElementById('refresh-apis')?.addEventListener('click', () => {
            loadAPIStatus();
        });

        function hideAll() {
            document.getElementById('status-display').classList.add('hidden');
            document.getElementById('results-display').classList.add('hidden');
            document.getElementById('error-display').classList.add('hidden');
        }

        function showStatus(message) {
            document.getElementById('status-text').textContent = message;
            document.getElementById('status-display').classList.remove('hidden');
        }

        function showResults(pageId) {
            hideAll();
            const link = `https://notion.so/${pageId.replace(/-/g, '')}`;
            document.getElementById('results-link').href = link;
            document.getElementById('results-display').classList.remove('hidden');
        }

        function showError(message) {
            hideAll();
            const errorTextEl = document.getElementById('error-text');

            // Convert markdown links to HTML links
            // Pattern: [text](url)
            const htmlMessage = message.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="underline hover:text-blue-600 font-medium" target="_blank">$1</a>');

            errorTextEl.innerHTML = htmlMessage;
            document.getElementById('error-display').classList.remove('hidden');
        }

        function updateUsageCounter(rateLimit) {
            if (rateLimit) {
                const used = rateLimit.total - rateLimit.remaining;
                document.getElementById('usage-counter').innerHTML =
                    `Analyses today: <span class="font-semibold">${used}/${rateLimit.total}</span>`;
            }
        }

        async function loadAPIStatus() {
            const loading = document.getElementById('admin-loading');
            const container = document.getElementById('api-status-container');

            loading.classList.remove('hidden');
            container.classList.add('hidden');

            try {
                const response = await fetch('/api/api-status');
                const data = await response.json();

                if (data.success) {
                    renderAPICards(data.apis);
                    renderCostSummary(data.apis, data.summary);
                    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

                    loading.classList.add('hidden');
                    container.classList.remove('hidden');
                } else {
                    showError('Failed to load API status');
                }
            } catch (error) {
                showError('Network error loading API status');
                loading.classList.add('hidden');
            }
        }

        function renderAPICards(apis) {
            const container = document.getElementById('api-cards');
            container.innerHTML = '';

            Object.entries(apis).forEach(([key, api]) => {
                const card = createAPICard(api);
                container.appendChild(card);
            });
        }

        function createAPICard(api) {
            const div = document.createElement('div');
            div.className = 'api-card bg-white border border-gray-200 rounded-lg p-6';

            const statusClass = `status-${api.status}`;
            const statusText = api.status.charAt(0).toUpperCase() + api.status.slice(1);

            div.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">${api.name}</h3>
                    <div class="flex items-center">
                        <span class="status-indicator ${statusClass}"></span>
                        <span class="text-sm font-medium text-gray-700">${statusText}</span>
                    </div>
                </div>

                ${api.details.model ? `
                    <div class="mb-2 text-sm text-gray-600">
                        <span class="font-medium">Model:</span> ${api.details.model}
                    </div>
                ` : ''}

                ${api.details.error ? `
                    <div class="mb-3 text-sm text-red-600">
                        <span class="font-medium">Error:</span> ${api.details.error}
                    </div>
                ` : ''}

                ${api.usage && api.usage.costToday !== undefined ? `
                    <div class="mb-3 text-sm text-gray-600">
                        <span class="font-medium">Cost Today:</span> $${api.usage.costToday.toFixed(2)}
                    </div>
                ` : ''}

                <div class="flex gap-2 mt-4">
                    <a
                        href="${api.links.docs}"
                        target="_blank"
                        class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium py-2 px-4 rounded transition duration-200"
                    >
                        Docs
                    </a>
                    ${api.links.dashboard ? `
                        <a
                            href="${api.links.dashboard}"
                            target="_blank"
                            class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded transition duration-200"
                        >
                            Dashboard
                        </a>
                    ` : ''}
                </div>
            `;

            return div;
        }

        function renderCostSummary(apis, summary) {
            const container = document.getElementById('cost-summary');
            const items = [];

            // Add individual API costs
            Object.entries(apis).forEach(([key, api]) => {
                if (api.usage && api.usage.costToday !== undefined) {
                    const calls = api.usage.callsToday || api.usage.tokensToday || 0;
                    const unit = api.usage.tokensToday ? 'tokens' : 'calls';
                    items.push(`
                        <div class="flex justify-between">
                            <span class="text-gray-700">• ${api.name}:</span>
                            <span class="font-medium">$${api.usage.costToday.toFixed(2)} (${calls} ${unit})</span>
                        </div>
                    `);
                }
            });

            // Add separator and totals
            items.push(`
                <div class="border-t border-gray-300 my-3"></div>
                <div class="flex justify-between font-semibold text-gray-900">
                    <span>Total Today:</span>
                    <span>$${summary.totalCostToday.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-gray-600">
                    <span>Monthly Projection:</span>
                    <span class="font-medium">$${summary.monthlyProjection.toFixed(2)}</span>
                </div>
            `);

            container.innerHTML = items.join('');
        }
    </script>
</body>
</html>
